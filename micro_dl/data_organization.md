# Data Organization for virtual staining

> This advisory only applies to data management on Biohub's compute infrastructure.
> It is not normative for external users.

Here we document the conventions for storing data, metadata, configs,
and models during the development of the virtual staining pipeline.

## Data flow in the pipeline

TODO: Following diagram captures the planned flow of data and metadata through the new version of the pipeline.

### Preprocessing

Parameters are provided via the CLI, and stored in the attributes of
the OME-Zarr datasets using [iohub](https://github.com/czbiohub/iohub).
The metadata is in json format that is practical to edit by hand.

### Training

We use the PyTorch Lightning framework for training,
which provides [good defaults](https://pytorch-lightning.readthedocs.io/en/1.6.5/common/lightning_cli.html)
for CLI and training configs,
and organized TensorBoard [logs](https://lightning.ai/docs/pytorch/stable/extensions/logging.html).

### Inference

The inference module does not depend on lightning, but just on PyTorch.
Parameters are provided with CLI and stored with the OME-Zarr datasets,
similar to preprocessing.

> This can be further incorporated into the lightning pipeline

### Evaluation

Evaluating the models requires human proof-reading of ground truth.
Currently computing the evaluation metrics does not depend on PyTorch.

> This can be further incorporated into the lightning pipeline

### Deployment

For run-time deployment, we export the model to the ONNX format.

## Data hierarchy

Data generated by above stages is written to four folders in our data hierarchy.

* Data and metadata produced by preprocessing is saved in `datasets`.
* Input to training (config files) and outputs of training (models) are saved in `models`.
* Data, metadata, and metrics produced by inference and evaluation stages is saved in `evaluation`.
* Deployed models are saved in `deployment`.

```text
<virtualstaining>
|
|- datasets (registered, deconvolved, preprocessed)
|   |- yyyy_dd_mm_<dataname0>.zarr
|   |- yyyy_dd_mm_<dataname1>.zarr
|    | ...
|- models
|   |-<experiment0>
|   |   |- lightning_logs
|   |   |- training_config0.yml
|   |   |- training_config1.yml
|   |   |- ...
|   |-<experiment1>
|   |   |- lightning_logs
|   |   |- training_config0.yml
|   |   |- training_config1.yml
|   |   |- ...
|- evaluation
|   |-<experiment0>  (match with paths in models)
|   |   |- predictions.zarr
|   |   |- groundtruth
|   |   |- metrics.csv
|   |   |- ...
|   |-<experiment1>
|   |   |- predictions.zarr
|   |   |- groundtruth
|   |   |- metrics.csv
|   |   |- ...
|- deployment
|   |-<experiment0>  (match with paths in models)
|   |   |- model0.onnx
|   |   |- model0.README
|   |   |...
```
